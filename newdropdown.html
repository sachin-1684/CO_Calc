<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COs Calculation - Page 2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to right, red, red);
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            color: black;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-size: 16px;
        }
        th {
            background-color:#c01520;
            color: white;
        }
        .summary-box {
            background: #f1f1f1;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
        }
        .co-marks-box {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 10px;
            background: #f1f1f1;
            margin-top: 20px;
            border-radius: 8px;
        }
        .co-marks-box p {
            margin: 5px 10px;
            font-size: 16px;
        }
        .red-bold {
            color: red;
            font-weight: bold;
        }
        button {
            margin-top: 15px;
            padding: 12px 25px;
            background-color:#c01520;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background-color: #0d47a1;
            transform: scale(1.05);
        }
        .student-management {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .upload-section, .selection-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 300px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .student-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        .student-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .student-item:hover {
            background-color: #f5f5f5;
        }
        .student-item.selected {
            background-color: #c01520;
            color: white;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #ffbb33;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        .edit-btn:hover {
            background-color: #ff8800;
        }
        .file-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .file-input-container input[type="file"] {
            flex-grow: 1;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .bulk-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }
        @media (max-width: 768px) {
            .student-management {
                flex-direction: column;
            }
            th, td {
                font-size: 14px;
                padding: 8px;
            }
            .container {
                width: 95%;
                padding: 15px;
            }
            .co-marks-box {
                flex-direction: column;
                align-items: center;
            }
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>CO Marks Allocation</h1>
    
    <div class="container">
        <div class="student-management">
            <div class="upload-section">
                <h2>Upload Student List</h2>
                <div class="file-input-container">
                    <input type="file" id="studentFile" accept=".csv">
                    <button onclick="uploadStudentList()">Upload</button>
                </div>
                <div id="uploadStatus"></div>
                <div id="studentListContainer" class="student-list" style="display: none;">
                    <h3>Uploaded Students</h3>
                    <button onclick="deleteStudentList()" class="delete-btn" style="margin-bottom: 10px;">Delete List</button>
                    <div id="studentList"></div>
                </div>
            </div>
            
            <div class="selection-section">
                <h2>Select Student</h2>
                <select id="studentSelect"></select>
                <button onclick="submitStudentData()">Submit Marks</button>
                <div id="currentStudent" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
        </div>
        
        <table>
            <tr>
                <th>Question</th>
                <th>Max Marks</th>
                <th>CO Assigned</th>
                <th>CO Marks</th>
            </tr>
            <tbody id="coTableBody"></tbody>
        </table>

        <div class="summary-box">
            <p>Total Questions Marks: <span id="totalMarksDisplay" class="red-bold">0/0</span></p>
        </div>

        <div class="co-marks-box" id="coMarksContainer">
            <!-- CO marks will be dynamically inserted here -->
        </div>

        <div class="summary-box">
            <p>Total CO Marks Assigned: <span id="totalCOMarks" class="red-bold">0</span></p>
        </div>
        
        <div class="action-buttons">
            <button onclick="downloadStudentCOData()">Download All CO Data (CSV)</button>
            <button onclick="homePage()">Home Page</button>
            <button onclick="resetPage()" style="background-color: #ff4444;">Reset Page</button>
        </div>
        
        <div id="submittedStudents" style="margin-top: 20px; text-align: left;">
            <h3>Submitted Students:</h3>
            <div class="bulk-actions">
                <button onclick="deleteSelectedStudents()" class="delete-btn">Delete Selected</button>
            </div>
            <div id="submittedList"></div>
        </div>
    </div>

    <script>
        // Global variables
        let studentData = JSON.parse(localStorage.getItem("studentData")) || [];
        let questionMarks = JSON.parse(localStorage.getItem("questionMarks")) || {};
        let selectedCOs = JSON.parse(localStorage.getItem("selectedCOs")) || {};
        let studentList = JSON.parse(localStorage.getItem("studentList")) || [];
        let currentStudent = null;
        let totalQMarks = 0;
        let activeCOs = new Set();
        let editMode = false;
        let currentEditIndex = -1;
        let selectedStudents = new Set();

        // Initialize the page
        window.onload = function() {
            loadData();
            populateTable();
            updateSubmittedList();
        };

        // Load data from localStorage
        function loadData() {
            // Load question data
            let storedMarks = localStorage.getItem("questionMarks");
            if (storedMarks) questionMarks = JSON.parse(storedMarks);

            let storedCOs = localStorage.getItem("selectedCOs");
            if (storedCOs) {
                selectedCOs = JSON.parse(storedCOs);
                // Find which COs are actually assigned
                Object.values(selectedCOs).forEach(co => {
                    if (co && co !== "Not Assigned") {
                        activeCOs.add(co);
                    }
                });
            }

            // Load student data
            let storedStudents = localStorage.getItem("studentList");
            if (storedStudents) {
                studentList = JSON.parse(storedStudents);
                showStudentList();
            }

            populateStudentDropdown();
        }

        // Upload student list from CSV
        function uploadStudentList() {
            let fileInput = document.getElementById("studentFile");
            let file = fileInput.files[0];

            if (!file) {
                alert("Please select a CSV file!");
                return;
            }

            let reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
                let lines = content.split('\n').filter(line => line.trim() !== '');
                
                studentList = [];
                for (let i = 0; i < lines.length; i++) {
                    let parts = lines[i].split(',');
                    if (parts.length >= 1) {
                        let uid = parts[0].trim();
                        let name = parts.length > 1 ? parts[1].trim() : uid;
                        studentList.push({ UID: uid, name: name });
                    }
                }

                localStorage.setItem("studentList", JSON.stringify(studentList));
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: green;">Successfully uploaded ${studentList.length} students!</span>`;
                showStudentList();
                populateStudentDropdown();
            };
            reader.onerror = function() {
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Error reading file!</span>`;
            };
            reader.readAsText(file);
        }

        // Delete uploaded student list
        function deleteStudentList() {
            if (confirm("Are you sure you want to delete the uploaded student list?")) {
                studentList = [];
                localStorage.removeItem("studentList");
                document.getElementById("studentList").innerHTML = "";
                document.getElementById("studentSelect").innerHTML = '<option value="">-- Select Student --</option>';
                document.getElementById("studentListContainer").style.display = "none";
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Student list deleted!</span>`;
            }
        }

        // Display uploaded students
        function showStudentList() {
            let container = document.getElementById("studentList");
            container.innerHTML = "";
            
            if (studentList.length === 0) {
                container.innerHTML = "<p>No students uploaded</p>";
                document.getElementById("studentListContainer").style.display = "none";
                return;
            }
            
            studentList.forEach(student => {
                let div = document.createElement("div");
                div.className = "student-item";
                div.innerHTML = `
                    <span>${student.name} (${student.UID})</span>
                `;
                div.onclick = function() {
                    document.getElementById("studentSelect").value = student.UID;
                    document.querySelectorAll(".student-item").forEach(item => {
                        item.classList.remove("selected");
                    });
                    div.classList.add("selected");
                };
                container.appendChild(div);
            });
            
            document.getElementById("studentListContainer").style.display = "block";
        }

        // Populate student dropdown
        function populateStudentDropdown() {
            let select = document.getElementById("studentSelect");
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            studentList.forEach(student => {
                let option = document.createElement("option");
                option.value = student.UID;
                option.textContent = `${student.name} (${student.UID})`;
                select.appendChild(option);
            });
        }

        // Create the questions table
        function populateTable() {
            let tableBody = document.getElementById("coTableBody");
            tableBody.innerHTML = "";
            totalQMarks = 0;

            Object.keys(questionMarks).forEach(q => {
                let maxMarks = questionMarks[q] || 0;
                totalQMarks += maxMarks;
                let co = selectedCOs[q] || "Not Assigned";

                let row = document.createElement("tr");
                row.innerHTML = `
                    <td>${q}</td>
                    <td>${maxMarks}</td>
                    <td>${co}</td>
                    <td><input type="number" min="0" max="${maxMarks}" id="${q}_marks" oninput="updateCOMarks()"></td>
                `;
                tableBody.appendChild(row);
            });

            updateCODisplay();
            updateTotalMarksDisplay();
        }

        // Update which COs to display based on assignments
        function updateCODisplay() {
            let coMarksContainer = document.getElementById("coMarksContainer");
            coMarksContainer.innerHTML = "";
            
            // Sort COs for consistent display
            let sortedCOs = Array.from(activeCOs).sort();
            
            sortedCOs.forEach(co => {
                let p = document.createElement("p");
                p.innerHTML = `<b>${co} :</b> <span id="${co.toLowerCase()}Marks" class="red-bold">0</span>`;
                coMarksContainer.appendChild(p);
            });
        }

        // Update marks display when values change
        function updateCOMarks() {
            let totalObtainedMarks = 0;
            let coMarks = {};
            
            // Initialize CO marks for active COs only
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });

            Object.keys(questionMarks).forEach(q => {
                let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                let maxMarks = questionMarks[q];
                let assignedCO = selectedCOs[q];

                // Validate marks don't exceed maximum
                if (marks > maxMarks) {
                    alert(`Marks for ${q} cannot exceed ${maxMarks}`);
                    document.getElementById(`${q}_marks`).value = maxMarks;
                    marks = maxMarks;
                }

                totalObtainedMarks += marks;

                // Only add to CO marks if CO is assigned and active
                if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                    coMarks[assignedCO] += marks;
                }
            });

            // Update CO marks display
            activeCOs.forEach(co => {
                document.getElementById(`${co.toLowerCase()}Marks`).innerText = coMarks[co];
            });
            
            // Update totals
            document.getElementById("totalCOMarks").innerText = Object.values(coMarks).reduce((a, b) => a + b, 0);
            document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
        }

        // Update the total marks display
        function updateTotalMarksDisplay() {
            let totalObtainedMarks = 0;
            Object.keys(questionMarks).forEach(q => {
                let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                totalObtainedMarks += marks;
            });
            document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
        }

        // Submit marks for selected student
        function submitStudentData() {
            let selectedUID = document.getElementById("studentSelect").value;
            
            if (!selectedUID) {
                alert("Please select a student!");
                return;
            }

            let student = studentList.find(s => s.UID === selectedUID);
            if (!student) {
                alert("Student not found in list!");
                return;
            }

            // Check if marks are entered
            let hasMarks = false;
            Object.keys(questionMarks).forEach(q => {
                if (document.getElementById(`${q}_marks`).value) {
                    hasMarks = true;
                }
            });
            
            if (!hasMarks) {
                alert("Please enter marks for at least one question!");
                return;
            }

            // Store original marks for each question
            let questionMarksData = {};
            Object.keys(questionMarks).forEach(q => {
                questionMarksData[q] = document.getElementById(`${q}_marks`).value || 0;
            });

            // Calculate marks
            let totalObtainedMarks = 0;
            let coMarks = {};
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });

            Object.keys(questionMarks).forEach(q => {
                let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                totalObtainedMarks += marks;
                
                let assignedCO = selectedCOs[q];
                if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                    coMarks[assignedCO] += marks;
                }
            });

            // Prepare student record
            let studentRecord = {
                UID: selectedUID,
                Name: student.name,
                ...coMarks,
                "Total Marks": totalObtainedMarks,
                "QuestionMarks": questionMarksData, // Store individual question marks
                Timestamp: new Date().toLocaleString()
            };

            if (editMode && currentEditIndex !== -1) {
                // Update existing record
                studentData[currentEditIndex] = studentRecord;
                editMode = false;
                currentEditIndex = -1;
                document.getElementById("studentSelect").disabled = false;
            } else {
                // Add new record
                studentData.push(studentRecord);
            }

            localStorage.setItem("studentData", JSON.stringify(studentData));
            document.getElementById("currentStudent").innerHTML = 
                `<span style="color: green;">Current: ${student.name} (${student.UID})</span>`;
            
            updateSubmittedList();
            clearMarks();
            alert(`Marks ${editMode ? 'updated' : 'submitted'} for ${student.name} (${student.UID})`);
        }

        // Edit student data - FIXED to restore exact marks
        function editStudentData(index) {
            let student = studentData[index];
            document.getElementById("studentSelect").value = student.UID;
            document.getElementById("studentSelect").disabled = true;
            
            // Clear all marks first
            clearMarks();
            
            // Restore the exact marks that were previously entered
            if (student.QuestionMarks) {
                Object.keys(student.QuestionMarks).forEach(q => {
                    let input = document.getElementById(`${q}_marks`);
                    if (input) {
                        input.value = student.QuestionMarks[q];
                    }
                });
            }
            
            editMode = true;
            currentEditIndex = index;
            updateCOMarks();
            
            // Update display to show we're in edit mode
            document.getElementById("currentStudent").innerHTML = 
                `<span style="color: blue;">Editing: ${student.Name} (${student.UID})</span>`;
        }

        // Delete student data
        function deleteStudentData(index) {
            if (confirm("Are you sure you want to delete this student's data?")) {
                studentData.splice(index, 1);
                localStorage.setItem("studentData", JSON.stringify(studentData));
                updateSubmittedList();
                alert("Student data deleted successfully!");
            }
        }

        // Delete selected students
        function deleteSelectedStudents() {
            if (selectedStudents.size === 0) {
                alert("Please select at least one student to delete!");
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedStudents.size} selected student(s)?`)) {
                // Convert Set to array and sort in descending order
                let indices = Array.from(selectedStudents).sort((a, b) => b - a);
                
                // Delete from highest index to lowest to avoid index shifting issues
                indices.forEach(index => {
                    studentData.splice(index, 1);
                });
                
                localStorage.setItem("studentData", JSON.stringify(studentData));
                selectedStudents.clear();
                updateSubmittedList();
                alert(`${indices.length} student(s) deleted successfully!`);
            }
        }

        // Toggle student selection
        function toggleStudentSelection(index, checkbox) {
            if (checkbox.checked) {
                selectedStudents.add(index);
            } else {
                selectedStudents.delete(index);
            }
        }

        // Clear all entered marks
        function clearMarks() {
            document.querySelectorAll("input[type='number']").forEach(input => input.value = "");
            updateCOMarks();
        }

        // Reset entire page
        function resetPage() {
            if (confirm("Are you sure you want to reset the entire page? This will clear all entered data.")) {
                // Clear form inputs
                clearMarks();
                document.getElementById("studentSelect").value = "";
                document.getElementById("studentSelect").disabled = false;
                
                // Reset edit mode
                editMode = false;
                currentEditIndex = -1;
                
                // Clear current student display
                document.getElementById("currentStudent").innerHTML = "";
                
                // Clear selected students
                selectedStudents.clear();
                
                alert("Page has been reset. All entered data has been cleared.");
            }
        }

        // Update the submitted students list
        function updateSubmittedList() {
            let container = document.getElementById("submittedList");
            container.innerHTML = "";
            
            if (studentData.length === 0) {
                container.innerHTML = "<p>No students submitted yet</p>";
                return;
            }
            
            let table = document.createElement("table");
            table.style.width = "100%";
            table.style.marginTop = "10px";
            
            // Create header with only active COs
            let header = table.createTHead();
            let headerRow = header.insertRow();
            ["Select", "No", "UID", "Name", ...Array.from(activeCOs).sort(), "Total Marks", "Actions"].forEach(text => {
                let th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
            });
            
            // Add data rows
            let tbody = table.createTBody();
            studentData.forEach((student, index) => {
                let row = tbody.insertRow();
                
                // Checkbox for selection
                let selectCell = row.insertCell();
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.onclick = (e) => toggleStudentSelection(index, e.target);
                selectCell.appendChild(checkbox);
                
                // Basic info
                [index + 1, student.UID, student.Name].forEach(value => {
                    let cell = row.insertCell();
                    cell.textContent = value;
                });
                
                // CO marks
                Array.from(activeCOs).sort().forEach(co => {
                    let cell = row.insertCell();
                    cell.textContent = student[co] || 0;
                });
                
                // Total marks
                let totalCell = row.insertCell();
                totalCell.textContent = student["Total Marks"] || 0;
                
                // Action buttons
                let actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn" onclick="editStudentData(${index})">Edit</button>
                    <button class="delete-btn" onclick="deleteStudentData(${index})">Delete</button>
                `;
            });
            
            container.appendChild(table);
        }

        // Download data as CSV with each CO in separate row
        function downloadStudentCOData() {
            if (studentData.length === 0) {
                alert("No student data available to download!");
                return;
            }
            
            // Prepare header
            let headers = ["Serial No", "UID", "Name", "CO", "Marks", "Total Marks"];
            let csvContent = headers.join(",") + "\n";
            
            // Add data rows - one row per CO per student
            let serialNo = 1;
            studentData.forEach((student) => {
                let sortedCOs = Array.from(activeCOs).sort();
                
                sortedCOs.forEach(co => {
                    let row = [
                        serialNo++,
                        student.UID,
                        `"${student.Name || student.UID}"`,
                        co,
                        student[co] || 0,
                        student["Total Marks"] || 0
                    ];
                    csvContent += row.join(",") + "\n";
                });
            });

            let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            let url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "Student_CO_Data_Detailed.csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Return to home page
        function homePage() {
            window.location.href = "try.html";
        }
    </script>
</body>
</html>