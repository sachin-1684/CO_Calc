<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COs Calculation - Page 2</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to right, red, red);
            color: white;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 15px auto;
            color: black;
        }
        h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 10px 0;
        }
        h2, h3 {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin: 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: clamp(12px, 2vw, 16px);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color:#c01520;
            color: white;
            position: sticky;
            top: 0;
        }
        .summary-box {
            background: #f1f1f1;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
        }
        .co-marks-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #f1f1f1;
            margin: 15px 0;
            border-radius: 8px;
        }
        .co-marks-box p {
            margin: 0;
            font-size: clamp(14px, 2vw, 16px);
            white-space: nowrap;
        }
        .red-bold {
            color: red;
            font-weight: bold;
        }
        button {
            margin: 10px 5px;
            padding: 10px 15px;
            background-color:#c01520;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: clamp(14px, 2vw, 18px);
            cursor: pointer;
            transition: 0.3s;
            min-width: 120px;
        }
        button:hover {
            background-color: #0d47a1;
            transform: scale(1.05);
        }
        .student-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .upload-section, .selection-section {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }
        .student-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 5px;
        }
        .student-item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: clamp(12px, 2vw, 14px);
        }
        .student-item:hover {
            background-color: #f5f5f5;
        }
        .student-item.selected {
            background-color: #c01520;
            color: white;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #ffbb33;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        .edit-btn:hover {
            background-color: #ff8800;
        }
        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        .file-input-container input[type="file"] {
            width: 100%;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
        }
        .bulk-actions {
            margin: 10px 0;
            display: flex;
            justify-content: flex-end;
        }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            font-size: clamp(12px, 2vw, 14px);
        }
        #currentStudent {
            margin: 10px 0;
            font-weight: bold;
            font-size: clamp(14px, 2vw, 16px);
        }
        #uploadStatus {
            font-size: clamp(12px, 2vw, 14px);
            margin: 5px 0;
        }
        .progress-summary {
            background: #f1f1f1;
            padding: 8px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }
        .progress-details {
            display: flex;
            justify-content: space-around;
            gap: 5px;
        }
        .progress-section {
            flex: 1;
        }
        .progress-section h4 {
            margin: 5px 0;
            color: #c01520;
            font-size: 14px;
        }
        .pending-students {
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            background: white;
            margin-top: 5px;
            font-size: 12px;
        }
        .pending-student {
            padding: 2px;
            border-bottom: 1px solid #eee;
        }
        .status-section {
            margin: 10px 0;
        }
        .status-A {
            color: green;
            font-weight: bold;
        }
        .status-I {
            color: orange;
            font-weight: bold;
        }
        .status-P {
            color: blue;
            font-weight: bold;
        }
        .marks-upload-section {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .download-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px dashed #c01520;
        }
        .duplicate-warning {
            color: #ff5722;
            font-weight: bold;
            margin: 5px 0;
        }
        .file-type-selector {
            margin-bottom: 10px;
        }
        .file-type-selector label {
            margin-right: 15px;
            cursor: pointer;
        }
        .file-type-selector input {
            margin-right: 5px;
        }
        @media (min-width: 768px) {
            .student-management {
                flex-direction: row;
            }
            .upload-section, .selection-section {
                width: 48%;
            }
            .file-input-container {
                flex-direction: row;
                align-items: center;
            }
            .file-input-container input[type="file"] {
                flex-grow: 1;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            th, td {
                padding: 6px 4px;
            }
            button {
                padding: 8px 12px;
                min-width: 100px;
            }
            .progress-details {
                flex-direction: column;
            }
        }
    </style>
    <!-- SheetJS library for Excel handling -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
</head>
<body>
    <h1>CO Marks Allocation</h1>
    
    <div class="container">
        <div class="student-management">
            <div class="upload-section">
                <h2>Upload Student List</h2>
                <div class="file-type-selector">
                    <label><input type="radio" name="studentFileType" value="csv" checked> CSV</label>
                    <label><input type="radio" name="studentFileType" value="excel"> Excel</label>
                </div>
                <div class="file-input-container">
                    <input type="file" id="studentFile" accept=".csv,.xlsx,.xls">
                    <button onclick="uploadStudentList()">Upload</button>
                </div>
                <div id="uploadStatus"></div>
                <div id="duplicateWarning" class="duplicate-warning" style="display: none;"></div>
                <div id="studentListContainer" class="student-list" style="display: none;">
                    <h3>Uploaded Students</h3>
                    <button onclick="deleteStudentList()" class="delete-btn" style="margin-bottom: 8px;">Delete List</button>
                    <div id="studentList"></div>
                </div>
            </div>
            
            <div class="selection-section">
                <h2>Select Student</h2>
                <select id="studentSelect"></select>
                
                <div class="status-section">
                    <label for="studentStatus">Status:</label>
                    <select id="studentStatus" onchange="handleStatusChange()">
                        <option value="P" selected>P (Present)</option>
                        <option value="A">A (Absent)</option>
                        <option value="I">I (Detained)</option>
                    </select>
                </div>
                
                <div id="currentStudent"></div>
                <button onclick="submitStudentData()">Submit</button>
            </div>
        </div>
        
        <!-- Progress Summary Section -->
        <div class="progress-summary" id="progressSummary" style="display: none;">
            <h4>Marks Submission Progress</h4>
            <div class="progress-details">
                <div class="progress-section">
                    <h4>Total: <span id="totalStudentsCount">0</span></h4>
                </div>
                <div class="progress-section">
                    <h4>Submitted: <span id="submittedStudentsCount">0</span></h4>
                </div>
                <div class="progress-section">
                    <h4>Pending: <span id="pendingStudentsCount">0</span></h4>
                </div>
            </div>
            <div class="pending-students" id="pendingStudentsList">
                No pending students
            </div>
        </div>
        
        <div style="overflow-x: auto;">
            <table id="questionsTable">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Max Marks</th>
                        <th>CO Assigned</th>
                        <th>CO Marks</th>
                    </tr>
                </thead>
                <tbody id="coTableBody"></tbody>
            </table>
        </div>
        <button onclick="submitStudentData()">Add Marks</button>
        <div class="summary-box">
            <p>Total Questions Marks: <span id="totalMarksDisplay" class="red-bold">0/0</span></p>
        </div>

        <div class="co-marks-box" id="coMarksContainer">
            <!-- CO marks will be dynamically inserted here -->
        </div>

        <div class="summary-box">
            <p>Total CO Marks Assigned: <span id="totalCOMarks" class="red-bold">0</span></p>
        </div>
        
        <div class="marks-upload-section">
            <h3>Upload Marks</h3>
            <div class="file-type-selector">
                <label><input type="radio" name="marksFileType" value="csv" checked> CSV</label>
                <label><input type="radio" name="marksFileType" value="excel"> Excel</label>
            </div>
            <div class="file-input-container">
                <input type="file" id="marksFile" accept=".csv,.xlsx,.xls">
                <button onclick="uploadMarksFromFile()">Upload Marks</button>
                <button onclick="removeMarksFile()" class="delete-btn" style="display:none;" id="removeMarksBtn">Remove File</button>
            </div>
            <div id="marksUploadStatus"></div>
            <div class="download-section" id="downloadUpdatedFile" style="display: none;">
                <h4>Download Updated File</h4>
                <div class="file-type-selector">
                    <label><input type="radio" name="downloadFileType" value="csv" checked> CSV</label>
                    <label><input type="radio" name="downloadFileType" value="excel"> Excel</label>
                </div>
                <button onclick="downloadUpdatedFile()" style="background-color: #4CAF50;">Download Updated File</button>
            </div>
        </div>

        <div id="submittedStudents" style="margin-top: 15px; text-align: left;">
            <h3>Submitted Students:</h3>
            <div class="bulk-actions">
                <button onclick="deleteSelectedStudents()" class="delete-btn">Delete Selected</button>
            </div>
            <div style="overflow-x: auto;">
                <div id="submittedList"></div>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="downloadStudentCOData()">Download All CO Data (CSV)</button>
            <button onclick="homePage()">Home Page</button>
            <button onclick="resetPage()" style="background-color: #ff4444;">Reset Page</button>
        </div>
    </div>

    <script>
        // Global variables
        let studentData = JSON.parse(localStorage.getItem("studentData")) || [];
        let questionMarks = JSON.parse(localStorage.getItem("questionMarks")) || {};
        let selectedCOs = JSON.parse(localStorage.getItem("selectedCOs")) || {};
        let studentList = JSON.parse(localStorage.getItem("studentList")) || [];
        let currentStudent = null;
        let totalQMarks = 0;
        let activeCOs = new Set();
        let editMode = false;
        let currentEditIndex = -1;
        let selectedStudents = new Set();
        let currentStatus = "P";
        let currentFileData = null;
        let currentFileType = null;

        // Initialize the page
        window.onload = function() {
            // First load the question data
            loadQuestionData();
            
            // Then load the rest of the data
            loadData();
            populateTable();
            updateSubmittedList();
            updateProgressSummary();
            
            // Ensure table is visible
            document.getElementById("questionsTable").style.display = "table";
        };

        // New function to specifically load question data
        function loadQuestionData() {
            let storedMarks = localStorage.getItem("questionMarks");
            if (storedMarks) {
                questionMarks = JSON.parse(storedMarks);
                // If no question marks found, initialize with default values
                if (Object.keys(questionMarks).length === 0) {
                    initializeDefaultQuestions();
                }
            } else {
                initializeDefaultQuestions();
            }
        }

        // Initialize default questions if none exist
        function initializeDefaultQuestions() {
            questionMarks = {
                "Q1": 0,
                "Q2": 0,
                "Q3": 0,
                "Q4": 0,
                "Q5": 0,
                "Q6": 0,
                "Q7": 0
            };
            localStorage.setItem("questionMarks", JSON.stringify(questionMarks));
        }

        // Load data from localStorage
        function loadData() {
            let storedCOs = localStorage.getItem("selectedCOs");
            if (storedCOs) {
                selectedCOs = JSON.parse(storedCOs);
                // Find which COs are actually assigned
                Object.values(selectedCOs).forEach(co => {
                    if (co && co !== "Not Assigned") {
                        activeCOs.add(co);
                    }
                });
            }

            // Load student data
            let storedStudents = localStorage.getItem("studentList");
            if (storedStudents) {
                studentList = JSON.parse(storedStudents);
                showStudentList();
            }

            populateStudentDropdown();
        }

        // Handle status change
        function handleStatusChange() {
            currentStatus = document.getElementById("studentStatus").value;
            updateInputFields();
            updateCOMarks();
        }

        // Update input fields based on status
        function updateInputFields() {
            Object.keys(questionMarks).forEach(q => {
                let input = document.getElementById(`${q}_marks`);
                if (currentStatus === "A") {
                    input.type = "text";
                    input.value = "A";
                    input.readOnly = true;
                } else if (currentStatus === "I") {
                    input.type = "text";
                    input.value = "I";
                    input.readOnly = true;
                } else {
                    input.type = "number";
                    input.readOnly = false;
                    input.min = "0";
                    input.max = questionMarks[q];
                    input.value = "";
                }
            });
        }

        // Process Excel file
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Process CSV file
        function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        const csvData = lines.map(line => line.split(','));
                        resolve(csvData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Upload marks from file (CSV or Excel)
        async function uploadMarksFromFile() {
            let fileInput = document.getElementById("marksFile");
            let file = fileInput.files[0];

            if (!file) {
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: red;">Please select a file!</span>`;
                return;
            }

            const fileType = document.querySelector('input[name="marksFileType"]:checked').value;
            
            try {
                let data;
                if (fileType === 'excel') {
                    data = await processExcelFile(file);
                } else {
                    data = await processCSVFile(file);
                }
                
                currentFileData = data;
                currentFileType = fileType;
                document.getElementById("removeMarksBtn").style.display = "inline-block";
                document.getElementById("downloadUpdatedFile").style.display = "block";
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: green;">File "${file.name}" uploaded successfully!</span>`;
            } catch (error) {
                console.error("Error processing file:", error);
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: red;">Error processing file: ${error.message}</span>`;
            }
        }

        // Remove uploaded marks file
        function removeMarksFile() {
            document.getElementById("marksFile").value = "";
            document.getElementById("removeMarksBtn").style.display = "none";
            document.getElementById("downloadUpdatedFile").style.display = "none";
            document.getElementById("marksUploadStatus").innerHTML = "";
            currentFileData = null;
            currentFileType = null;
        }

        // Convert data to CSV format
        function convertToCSV(data) {
            return data.map(row => row.join(',')).join('\n');
        }

        // Download updated file (CSV or Excel)
        // Download updated file (CSV or Excel) - FIXED VERSION
        function downloadUpdatedFile() {
    if (!currentFileData) {
        alert("No file data available to process!");
        return;
    }

    const fileType = document.querySelector('input[name="downloadFileType"]:checked').value;
    let updatedData = processFileData(currentFileData);
    
    if (updatedData.length === 0) return;
    
    if (fileType === 'excel') {
        try {
            // Convert to worksheet
            let ws;
            if (Array.isArray(updatedData[0])) {
                // Array of arrays
                ws = XLSX.utils.aoa_to_sheet(updatedData);
            } else {
                // Array of objects
                ws = XLSX.utils.json_to_sheet(updatedData);
            }
            
            // Create workbook and add worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "MarksData");
            
            // Generate and download Excel file
            XLSX.writeFile(wb, "updated_marks.xlsx");
        } catch (error) {
            console.error("Error generating Excel file:", error);
            alert("Error generating Excel file: " + error.message);
        }
    } else {
        // Download CSV
        let csvContent;
        if (Array.isArray(updatedData[0])) {
            // Array of arrays
            csvContent = updatedData.map(row => row.join(',')).join('\n');
        } else {
            // Array of objects
            const headers = Object.keys(updatedData[0]);
            csvContent = [
                headers.join(','),
                ...updatedData.map(row => headers.map(h => row[h]).join(','))
            ].join('\n');
        }
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement("a");
        a.href = url;
        a.download = "updated_marks.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}



        // Process file data to update marks
        function processFileData(data) {
    let updatedData = [];
    
    // First determine if we have array of arrays or array of objects
    const isArrayOfArrays = Array.isArray(data[0]);
    
    // Get headers
    let headers = isArrayOfArrays ? data[0] : Object.keys(data[0]);
    
    // Find index of key columns
    const uidCol = headers.findIndex(h => h.includes("UID"));
    const coCol = headers.findIndex(h => h.includes("CourseOu"));
    const marksCol = headers.findIndex(h => h.includes("MarkObtd"));
    
    // Return empty if we don't have required columns
    if (uidCol === -1 || coCol === -1 || marksCol === -1) {
        alert("Required columns (UID, CourseOu, MarkObtd) not found in file!");
        return [];
    }
    
    // Process each row
    for (let i = isArrayOfArrays ? 1 : 0; i < data.length; i++) {
        let row = data[i];
        
        // Convert to array format if it's an object
        if (!Array.isArray(row)) {
            row = headers.map(h => row[h]);
        }
        
        // Get UID and CO
        let uid = row[uidCol] ? row[uidCol].toString().trim() : '';
        let co = row[coCol] ? row[coCol].toString().trim() : '';
        
        // Find matching student and update marks
        if (uid && co) {
            let matchingStudent = studentData.find(s => s.UID === uid);
            if (matchingStudent) {
                row[marksCol] = matchingStudent[co] || 0;
            }
        }
        
        updatedData.push(row);
    }
    
    // Return in same format as input
    return isArrayOfArrays ? [headers, ...updatedData] : updatedData.map(row => {
        let obj = {};
        headers.forEach((h, idx) => {
            obj[h] = row[idx];
        });
        return obj;
    });
}


        // Upload student list from file (CSV or Excel)
        async function uploadStudentList() {
            let fileInput = document.getElementById("studentFile");
            let file = fileInput.files[0];

            if (!file) {
                alert("Please select a file!");
                return;
            }

            const fileType = document.querySelector('input[name="studentFileType"]:checked').value;
            
            try {
                let data;
                if (fileType === 'excel') {
                    data = await processExcelFile(file);
                } else {
                    data = await processCSVFile(file);
                }
                
                let tempStudentList = [];
                let duplicateCount = 0;
                let seenCombinations = new Set();
                
                // Start from index 1 to skip header row (assuming first row is header)
                for (let i = 1; i < data.length; i++) {
                    let row = data[i];
                    if (row.length >= 3) { // Ensure we have at least columns A, B, and C
                        let name = row[0] ? row[0].toString().trim() : ''; // Column A (Name)
                        let uid = row[2] ? row[2].toString().trim() : ''; // Column C (UID)
                        
                        // Create a unique key combining UID and Name
                        let combinationKey = `${uid}_${name}`;
                        
                        // Check if this UID-Name combination already exists
                        if (seenCombinations.has(combinationKey)) {
                            duplicateCount++;
                            continue;
                        }
                        
                        seenCombinations.add(combinationKey);
                        tempStudentList.push({ UID: uid, name: name });
                    }
                }

                studentList = tempStudentList;
                localStorage.setItem("studentList", JSON.stringify(studentList));
                
                let uploadStatus = document.getElementById("uploadStatus");
                uploadStatus.innerHTML = 
                    `<span style="color: green;">Successfully uploaded ${studentList.length} students!</span>`;
                
                if (duplicateCount > 0) {
                    document.getElementById("duplicateWarning").style.display = "block";
                    document.getElementById("duplicateWarning").textContent = 
                        `Note: ${duplicateCount} duplicate entries (same UID and Name) were removed from the list.`;
                } else {
                    document.getElementById("duplicateWarning").style.display = "none";
                }
                
                showStudentList();
                populateStudentDropdown();
                updateProgressSummary();
            } catch (error) {
                console.error("Error processing student list:", error);
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Error processing file: ${error.message}</span>`;
            }
        }

        // Delete uploaded student list
        function deleteStudentList() {
            if (confirm("Are you sure you want to delete the uploaded student list?")) {
                studentList = [];
                localStorage.removeItem("studentList");
                document.getElementById("studentList").innerHTML = "";
                document.getElementById("studentSelect").innerHTML = '<option value="">-- Select Student --</option>';
                document.getElementById("studentListContainer").style.display = "none";
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Student list deleted!</span>`;
                document.getElementById("duplicateWarning").style.display = "none";
                updateProgressSummary();
            }
        }

        // Display uploaded students
        function showStudentList() {
            let container = document.getElementById("studentList");
            container.innerHTML = "";
            
            if (studentList.length === 0) {
                container.innerHTML = "<p>No students uploaded</p>";
                document.getElementById("studentListContainer").style.display = "none";
                return;
            }
            
            studentList.forEach(student => {
                let div = document.createElement("div");
                div.className = "student-item";
                div.innerHTML = `
                    <span>${student.name} (${student.UID})</span>
                `;
                div.onclick = function() {
                    document.getElementById("studentSelect").value = student.UID;
                    document.querySelectorAll(".student-item").forEach(item => {
                        item.classList.remove("selected");
                    });
                    div.classList.add("selected");
                };
                container.appendChild(div);
            });
            
            document.getElementById("studentListContainer").style.display = "block";
        }

        // Populate student dropdown
        function populateStudentDropdown() {
            let select = document.getElementById("studentSelect");
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            studentList.forEach(student => {
                let option = document.createElement("option");
                option.value = student.UID;
                option.textContent = `${student.name} (${student.UID})`;
                select.appendChild(option);
            });
        }

        // Create the questions table
        function populateTable() {
            let tableBody = document.getElementById("coTableBody");
            tableBody.innerHTML = "";
            totalQMarks = 0;

            // Ensure we have questions to display
            if (Object.keys(questionMarks).length === 0) {
                initializeDefaultQuestions();
            }

            Object.keys(questionMarks).forEach(q => {
                let maxMarks = questionMarks[q] || 0;
                totalQMarks += maxMarks;
                let co = selectedCOs[q] || "Not Assigned";

                let row = document.createElement("tr");
                let input = document.createElement("input");
                input.id = `${q}_marks`;
                input.oninput = function() { updateCOMarks(); };
                
                if (currentStatus === "A") {
                    input.type = "text";
                    input.value = "A";
                    input.readOnly = true;
                } else if (currentStatus === "I") {
                    input.type = "text";
                    input.value = "I";
                    input.readOnly = true;
                } else {
                    input.type = "number";
                    input.min = "0";
                    input.max = maxMarks;
                }

                row.innerHTML = `
                    <td>${q}</td>
                    <td>${maxMarks}</td>
                    <td>${co}</td>
                    <td></td>
                `;
                row.cells[3].appendChild(input);
                tableBody.appendChild(row);
            });

            // Make sure table is visible
            document.getElementById("questionsTable").style.display = "table";
            updateCODisplay();
            updateTotalMarksDisplay();
        }

        // Update which COs to display based on assignments
        function updateCODisplay() {
            let coMarksContainer = document.getElementById("coMarksContainer");
            coMarksContainer.innerHTML = "";
            
            // Sort COs for consistent display (Q1-Q7 first, then A/I)
            let sortedCOs = Array.from(activeCOs).sort((a, b) => {
                if (a.startsWith('Q') && b.startsWith('Q')) {
                    return parseInt(a.substring(1)) - parseInt(b.substring(1));
                } else if (a.startsWith('Q')) {
                    return -1;
                } else if (b.startsWith('Q')) {
                    return 1;
                } else {
                    return a.localeCompare(b);
                }
            });
            
            sortedCOs.forEach(co => {
                let p = document.createElement("p");
                p.innerHTML = `<b>${co} :</b> <span id="${co.toLowerCase()}Marks" class="red-bold">0</span>`;
                coMarksContainer.appendChild(p);
            });
        }

        // Update marks display when values change
        function updateCOMarks() {
            let totalObtainedMarks = 0;
            let coMarks = {};
            
            // Initialize CO marks for active COs only
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });

            if (currentStatus === "A") {
                // Absent - all marks are "A"
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "A";
                    }
                });
                
                // Update display to show "A" for all COs
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = "A";
                });
                
                document.getElementById("totalCOMarks").innerText = "A";
                document.getElementById("totalMarksDisplay").innerText = `A/${totalQMarks}`;
                return;
            }
            else if (currentStatus === "I") {
                // Detained - all marks are "I"
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "I";
                    }
                });
                
                // Update display to show "I" for all COs
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = "I";
                });
                
                document.getElementById("totalCOMarks").innerText = "I";
                document.getElementById("totalMarksDisplay").innerText = `I/${totalQMarks}`;
                return;
            }
            else {
                // Present - calculate marks based on inputs
                Object.keys(questionMarks).forEach(q => {
                    let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                    let maxMarks = questionMarks[q];
                    let assignedCO = selectedCOs[q];

                    // Validate marks don't exceed maximum
                    if (marks > maxMarks) {
                        alert(`Marks for ${q} cannot exceed ${maxMarks}`);
                        document.getElementById(`${q}_marks`).value = maxMarks;
                        marks = maxMarks;
                    }

                    totalObtainedMarks += marks;

                    // Only add to CO marks if CO is assigned and active
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] += marks;
                    }
                });

                // Update CO marks display
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = coMarks[co];
                });
                
                // Update totals
                document.getElementById("totalCOMarks").innerText = Object.values(coMarks).reduce((a, b) => a + b, 0);
                document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
            }
        }

        // Update the total marks display
        function updateTotalMarksDisplay() {
            let totalObtainedMarks = 0;
            Object.keys(questionMarks).forEach(q => {
                let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                totalObtainedMarks += marks;
            });
            document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
        }

        // Submit marks for selected student
        function submitStudentData() {
            let selectedUID = document.getElementById("studentSelect").value;
            
            if (!selectedUID) {
                alert("Please select a student!");
                return;
            }

            let student = studentList.find(s => s.UID === selectedUID);
            if (!student) {
                alert("Student not found in list!");
                return;
            }

            // Get current status
            let status = document.getElementById("studentStatus").value;

            // Store original marks for each question
            let questionMarksData = {};
            Object.keys(questionMarks).forEach(q => {
                questionMarksData[q] = document.getElementById(`${q}_marks`).value || 0;
            });

            // Calculate marks
            let totalObtainedMarks = 0;
            let coMarks = {};
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });

            if (status === "A") {
                // Absent - all marks are "A"
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "A";
                    }
                });
            } 
            else if (status === "I") {
                // Detained - all marks are "I"
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "I";
                    }
                });
            }
            else {
                // Present - calculate marks based on inputs
                Object.keys(questionMarks).forEach(q => {
                    let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                    totalObtainedMarks += marks;
                    
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] += marks;
                    }
                });
            }

            // Prepare student record
            let studentRecord = {
                UID: selectedUID,
                Name: student.name,
                Status: status,
                ...coMarks,
                "Total Marks": status === "A" ? "A" : (status === "I" ? "I" : totalObtainedMarks),
                "QuestionMarks": questionMarksData, // Store individual question marks
                Timestamp: new Date().toLocaleString()
            };

            if (editMode && currentEditIndex !== -1) {
                // Update existing record
                studentData[currentEditIndex] = studentRecord;
                editMode = false;
                currentEditIndex = -1;
                document.getElementById("studentSelect").disabled = false;
                document.getElementById("studentStatus").disabled = false;
                document.getElementById("currentStudent").innerHTML = "";
            } else {
                // Add new record
                studentData.push(studentRecord);
            }

            localStorage.setItem("studentData", JSON.stringify(studentRecord));
            document.getElementById("currentStudent").innerHTML = 
                `<span style="color: green;">Current: ${student.name} (${student.UID}) - Status: ${status}</span>`;
            
            updateSubmittedList();
            updateProgressSummary();
            clearMarks();
            alert(`Marks ${editMode ? 'updated' : 'submitted'} for ${student.name} (${student.UID})`);
        }

        // Edit student data - Restores exact marks
        function editStudentData(index) {
            let student = studentData[index];
            document.getElementById("studentSelect").value = student.UID;
            document.getElementById("studentSelect").disabled = true;
            
            // Set the status
            document.getElementById("studentStatus").value = student.Status || "P";
            currentStatus = student.Status || "P";
            
            // Clear all marks first
            clearMarks();
            
            // Restore the exact marks that were previously entered
            if (student.QuestionMarks) {
                Object.keys(student.QuestionMarks).forEach(q => {
                    let input = document.getElementById(`${q}_marks`);
                    if (input) {
                        if (student.Status === "A") {
                            input.value = "A";
                            input.readOnly = true;
                        } else if (student.Status === "I") {
                            input.value = "I";
                            input.readOnly = true;
                        } else {
                            input.value = student.QuestionMarks[q];
                        }
                    }
                });
            }
            
            editMode = true;
            currentEditIndex = index;
            updateCOMarks();
            
            // Update display to show we're in edit mode
            document.getElementById("currentStudent").innerHTML = 
                `<span style="color: blue;">Editing: ${student.Name} (${student.UID}) - Status: ${student.Status || "P"}</span>`;
        }

        // Delete student data
        function deleteStudentData(index) {
            if (confirm("Are you sure you want to delete this student's data?")) {
                studentData.splice(index, 1);
                localStorage.setItem("studentData", JSON.stringify(studentData));
                updateSubmittedList();
                updateProgressSummary();
                alert("Student data deleted successfully!");
            }
        }

        // Delete selected students
        function deleteSelectedStudents() {
            if (selectedStudents.size === 0) {
                alert("Please select at least one student to delete!");
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedStudents.size} selected student(s)?`)) {
                // Convert Set to array and sort in descending order
                let indices = Array.from(selectedStudents).sort((a, b) => b - a);
                
                // Delete from highest index to lowest to avoid index shifting issues
                indices.forEach(index => {
                    studentData.splice(index, 1);
                });
                
                localStorage.setItem("studentData", JSON.stringify(studentData));
                selectedStudents.clear();
                updateSubmittedList();
                updateProgressSummary();
                alert(`${indices.length} student(s) deleted successfully!`);
            }
        }

        // Toggle student selection
        function toggleStudentSelection(index, checkbox) {
            if (checkbox.checked) {
                selectedStudents.add(index);
            } else {
                selectedStudents.delete(index);
            }
        }

        // Clear all entered marks
        function clearMarks() {
            document.querySelectorAll("input[type='number'], input[type='text']").forEach(input => {
                input.type = "number";
                input.readOnly = false;
                input.min = "0";
                input.max = questionMarks[input.id.replace('_marks', '')] || 0;
                input.value = "";
            });
            document.getElementById("studentStatus").value = "P";
            currentStatus = "P";
            updateCOMarks();
        }

        // Reset entire page
        function resetPage() {
            if (confirm("Are you sure you want to reset the entire page? This will clear all entered data.")) {
                // Clear form inputs
                clearMarks();
                document.getElementById("studentSelect").value = "";
                document.getElementById("studentSelect").disabled = false;
                document.getElementById("studentStatus").disabled = false;
                
                // Reset edit mode
                editMode = false;
                currentEditIndex = -1;
                
                // Clear current student display
                document.getElementById("currentStudent").innerHTML = "";
                
                // Clear selected students
                selectedStudents.clear();
                
                alert("Page has been reset. All entered data has been cleared.");
            }
        }

        // Update the submitted students list
        function updateSubmittedList() {
            let container = document.getElementById("submittedList");
            container.innerHTML = "";
            
            if (studentData.length === 0) {
                container.innerHTML = "<p>No students submitted yet</p>";
                return;
            }
            
            let table = document.createElement("table");
            table.style.width = "100%";
            table.style.marginTop = "10px";
            
            // Create header with only active COs
            let header = table.createTHead();
            let headerRow = header.insertRow();
            ["Select", "No", "Name", "UID", ...Array.from(activeCOs).sort(), "Total Marks", "Actions"].forEach(text => {
                let th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
            });
            
            // Add data rows
            let tbody = table.createTBody();
            studentData.forEach((student, index) => {
                let row = tbody.insertRow();
                
                // Checkbox for selection
                let selectCell = row.insertCell();
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.onclick = (e) => toggleStudentSelection(index, e.target);
                selectCell.appendChild(checkbox);
                
                // Basic info
                [index + 1, student.UID, student.Name].forEach(value => {
                    let cell = row.insertCell();
                    cell.textContent = value;
                });
                
                // CO marks
                Array.from(activeCOs).sort().forEach(co => {
                    let cell = row.insertCell();
                    if (student.Status === "A") {
                        cell.innerHTML = '<span class="status-A">A</span>';
                    } else if (student.Status === "I") {
                        cell.innerHTML = '<span class="status-I">I</span>';
                    } else {
                        cell.textContent = student[co] || 0;
                    }
                });
                
                // Total marks
                let totalCell = row.insertCell();
                if (student.Status === "A") {
                    totalCell.innerHTML = '<span class="status-A">A</span>';
                } else if (student.Status === "I") {
                    totalCell.innerHTML = '<span class="status-I">I</span>';
                } else {
                    totalCell.textContent = student["Total Marks"] || 0;
                }
                
                // Action buttons
                let actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn" onclick="editStudentData(${index})">Edit</button>
                    <button class="delete-btn" onclick="deleteStudentData(${index})">Delete</button>
                `;
            });
            
            container.appendChild(table);
        }

        // Update progress summary
        function updateProgressSummary() {
            const progressSummary = document.getElementById("progressSummary");
            const totalStudentsCount = document.getElementById("totalStudentsCount");
            const submittedStudentsCount = document.getElementById("submittedStudentsCount");
            const pendingStudentsCount = document.getElementById("pendingStudentsCount");
            const pendingStudentsList = document.getElementById("pendingStudentsList");
            
            if (studentList.length === 0) {
                progressSummary.style.display = "none";
                return;
            }
            
            progressSummary.style.display = "block";
            
            const totalStudents = studentList.length;
            const submittedStudents = studentData.length;
            const pendingStudents = totalStudents - submittedStudents;
            
            totalStudentsCount.textContent = totalStudents;
            submittedStudentsCount.textContent = submittedStudents;
            pendingStudentsCount.textContent = pendingStudents;
            
            // Find which students are pending
            const submittedUIDs = new Set(studentData.map(s => s.UID));
            const pendingStudentsData = studentList.filter(s => !submittedUIDs.has(s.UID));
            
            if (pendingStudentsData.length === 0) {
                pendingStudentsList.innerHTML = "<div class='pending-student'>All students have marks submitted!</div>";
            } else {
                pendingStudentsList.innerHTML = "";
                pendingStudentsData.forEach(student => {
                    const div = document.createElement("div");
                    div.className = "pending-student";
                    div.textContent = `${student.UID} - ${student.name}`;
                    pendingStudentsList.appendChild(div);
                });
            }
        }

        // Download data as CSV with each CO in separate row
        function downloadStudentCOData() {
            if (studentData.length === 0) {
                alert("No student data available to download!");
                return;
            }
            
            // Prepare header
            let headers = ["Serial No", "Name", "UID", "Status", "CO", "Marks", "Total Marks"];
            let csvContent = headers.join(",") + "\n";
            
            // Add data rows - one row per CO per student
            let serialNo = 1;
            studentData.forEach((student) => {
                let sortedCOs = Array.from(activeCOs).sort();
                
                sortedCOs.forEach(co => {
                    let row = [
                        serialNo++,
                        student.UID,
                        `"${student.Name || student.UID}"`,
                        student.Status || "P",
                        co,
                        student.Status === "A" ? "A" : (student.Status === "I" ? "I" : (student[co] || 0)),
                        student.Status === "A" ? "A" : (student.Status === "I" ? "I" : (student["Total Marks"] || 0))
                    ];
                    csvContent += row.join(",") + "\n";
                });
            });

            let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            let url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "Student_CO_Data_Detailed.csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Return to home page
        function homePage() {
            window.location.href = "EST_CO_Calc_WL.html";
        }
    </script>
</body>
</html>