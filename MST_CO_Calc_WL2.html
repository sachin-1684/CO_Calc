<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COs Calculation - Page 2</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to bottom, red, rgb(100, 34, 255));
            color: white;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 15px auto;
            color: black;
        }
        h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 10px 0;
        }
        h2, h3 {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin: 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: clamp(12px, 2vw, 16px);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #c01520;
            color: white;
            position: sticky;
            top: 0;
        }
        .learner-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .learner-item:hover {
            background-color: #f5f5f5;
        }
        .learner-percentage {
            font-weight: bold;
        }
        .slow-learner {
            color: #ff9800;
        }
        .fast-learner {
            color: #4caf50;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .summary-box {
            background: #4ccaea82;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
        }
        .co-marks-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #f1f1f1;
            margin: 15px 0;
            border-radius: 8px;
        }
        .co-marks-box p {
            margin: 0;
            font-size: clamp(14px, 2vw, 16px);
            white-space: nowrap;
        }
        .co-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: #e21c11;
            margin: 15px 0;
            border-radius: 8px;
        }
        .co-card {
            background: rgb(255, 255, 255);
            border-radius: 15px;
            padding: 15px;
            width: 130px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .co-card h4 {
            margin: 0 0 10px;
            color: #090909;
            font-size: 1.2rem;
        }
        .co-card p {
            margin: 5px 0;
            font-size: 1rem;
            font-weight: bold;
        }
        .progress-bar {
            width: 100%;
            background: #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin-top: 10px;
        }
        .progress {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s ease;
        }
        .red-bold {
            color: red;
            font-weight: bold;
        }
        button {
            margin: 10px 5px;
            padding: 10px 15px;
            background-color: #c01520;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: clamp(14px, 2vw, 18px);
            cursor: pointer;
            transition: 0.3s;
            min-width: 120px;
        }
        button:hover {
            background-color: #0d47a1;
            transform: scale(1.05);
        }
        .student-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        .upload-section, .selection-section {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }
        .student-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 5px;
        }
        .student-item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: clamp(12px, 2vw, 14px);
        }
        .student-item:hover {
            background-color: #f5f5f5;
        }
        .student-item.selected {
            background-color: #c01520;
            color: white;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #ffbb33;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        .edit-btn:hover {
            background-color: #ff8800;
        }
        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        .file-input-container input[type="file"] {
            width: 100%;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
        }
        .bulk-actions {
            margin: 10px 0;
            display: flex;
            justify-content: flex-end;
        }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            font-size: clamp(12px, 2vw, 14px);
        }
        #currentStudent {
            margin: 10px 0;
            font-weight: bold;
            font-size: clamp(14px, 2vw, 16px);
        }
        #uploadStatus {
            font-size: clamp(12px, 2vw, 14px);
            margin: 5px 0;
        }
        .progress-summary {
            background: #f1f1f1;
            padding: 8px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }
        .progress-details {
            display: flex;
            justify-content: space-around;
            gap: 5px;
        }
        .progress-section {
            flex: 1;
        }
        .progress-section h4 {
            margin: 5px 0;
            color: #c01520;
            font-size: 14px;
        }
        .pending-students {
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            background: white;
            margin-top: 5px;
            font-size: 12px;
        }
        .pending-student {
            padding: 2px;
            border-bottom: 1px solid #eee;
        }
        .status-section {
            margin: 10px 0;
            font-weight: bold;
        }
        .status-A {
            color: green;
            font-weight: bold;
        }
        .status-I {
            color: orange;
            font-weight: bold;
        }
        .status-P {
            color: blue;
            font-weight: bold;
        }
        .marks-upload-section {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .download-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px dashed #c01520;
        }
        .duplicate-warning {
            color: #ff5722;
            font-weight: bold;
            margin: 5px 0;
        }
        .file-type-selector {
            margin-bottom: 10px;
        }
        .file-type-selector label {
            margin-right: 15px;
            cursor: pointer;
        }
        .file-type-selector input {
            margin-right: 5px;
        }
        @media (min-width: 768px) {
            .student-management {
                flex-direction: row;
            }
            .upload-section, .selection-section {
                width: 48%;
            }
            .file-input-container {
                flex-direction: row;
                align-items: center;
            }
            .file-input-container input[type="file"] {
                flex-grow: 1;
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            th, td {
                padding: 6px 4px;
            }
            button {
                padding: 8px 12px;
                min-width: 100px;
            }
            .progress-details {
                flex-direction: column;
            }
            .co-card {
                width: 20%;
            }
        }
    </style>
    <!-- SheetJS library for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>CO Marks Allocation</h1>
    
    <div class="container">
        <div class="student-management">
            <div class="upload-section">
                <h2>Upload Student List</h2>
                <div class="file-type-selector">
                    <label><input type="radio" name="studentFileType" value="csv" checked> CSV</label>
                    <label><input type="radio" name="studentFileType" value="excel"> Excel</label>
                </div>
                <div class="file-input-container">
                    <input type="file" id="studentFile" accept=".csv,.xlsx,.xls">
                    <button onclick="uploadStudentList()">Upload</button>
                    <button onclick="removeMarksFile1()" class="delete-btn" style="display:none;" id="removeMarksBtn1">Remove File</button>
                </div>
                <div id="uploadStatus"></div>
                <div id="duplicateWarning" class="duplicate-warning" style="display: none;"></div>
                <div id="studentListContainer" class="student-list" style="display: none;">
                    <h3>Uploaded Students</h3>
                    <button onclick="deleteStudentList()" class="delete-btn" style="margin-bottom: 8px;">Delete List</button>
                    <button onclick="sortStudentList()" class="delete-btn" style="margin-bottom: 8px;">Sort Student List</button>
                    <div id="studentList"></div>
                </div>
                <div class="learner-analysis-section" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3>Learner Analysis</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="analyzeLearners('slow')" style="background-color: #ff6a00; color: white;">
                            <i class="fas fa-user-clock"></i> Identify Slow Learners (≤40%)
                        </button>
                        <button onclick="analyzeLearners('fast')" style="background-color: #4caf50; color: white;">
                            <i class="fas fa-user-graduate"></i> Identify Fast Learners (≥85%)
                        </button>
                    </div>
                    <div id="learnerResults" style="display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <h4 id="learnerResultsTitle"></h4>
                            <button onclick="downloadLearnerResults()" style="background-color: #2196F3; color: white;">
                                <i class="fas fa-download"></i> Download List
                            </button>
                        </div>
                        <div id="learnerResultsTable" style="overflow-x: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="selection-section">
                <h2>Select Student</h2>
                <select id="studentSelect"></select>
                <div class="status-section">
                    <label for="studentStatus"><b>Student Status</b></label>
                    <select id="studentStatus" onchange="handleStatusChange()">
                        <option value="P" selected>P (Present)</option>
                        <option value="A">A (Absent)</option>
                        <option value="I">I (Detained)</option>
                    </select>
                </div>
                <div id="currentStudent"></div>
                <button onclick="submitStudentData()">Submit</button>
            </div>
        </div>
        <!-- Progress Summary Section -->
        <div class="progress-summary" id="progressSummary" style="display: none;">
            <h4>Marks Submission Progress</h4>
            <div class="progress-details">
                <div class="progress-section">
                    <h4>Total: <span id="totalStudentsCount">0</span></h4>
                </div>
                <div class="progress-section">
                    <h4>Submitted: <span id="submittedStudentsCount">0</span></h4>
                </div>
                <div class="progress-section">
                    <h4>Pending: <span id="pendingStudentsCount">0</span></h4>
                </div>
            </div>
            <div class="pending-students" id="pendingStudentsList">
                No pending students
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table id="questionsTable">
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Max Marks</th>
                        <th>CO Assigned</th>
                        <th>CO Marks</th>
                    </tr>
                </thead>
                <tbody id="coTableBody"></tbody>
            </table>
        </div>
        <button onclick="submitStudentData()">Add Marks</button>
        <div class="summary-box">
            <p>Total Obtained Marks: <span id="totalMarksDisplay" class="red-bold">0/0</span></p>
        </div>
        <div class="co-marks-box" id="coMarksContainer"></div>
        <div class="co-cards" id="coCardsContainer"></div>
        <div class="marks-upload-section">
            <h3>Upload Marks</h3>
            <div class="file-type-selector">
                <label><input type="radio" name="marksFileType" value="csv" checked> CSV</label>
                <label><input type="radio" name="marksFileType" value="excel"> Excel</label>
            </div>
            <div class="file-input-container">
                <input type="file" id="marksFile" accept=".csv,.xlsx,.xls">
                <button onclick="uploadMarksFromFile()">Upload Marks</button>
                <button onclick="removeMarksFile()" class="delete-btn" style="display:none;" id="removeMarksBtn">Remove File</button>
            </div>
            <div id="marksUploadStatus"></div>
            <div class="download-section" id="downloadUpdatedFile" style="display: none;">
                <h4>Download Updated File</h4>
                <div class="file-type-selector">
                    <label><input type="radio" name="downloadFileType" value="csv" checked> CSV</label>
                    <label><input type="radio" name="downloadFileType" value="excel"> Excel</label>
                </div>
                <button onclick="downloadUpdatedFile()" style="background-color: #4CAF50;">Download Updated File</button>
            </div>
        </div>
        <div id="submittedStudents" style="margin-top: 15px; text-align: left;">
            <h3>Submitted Students:</h3>
            <div class="bulk-actions">
                <label style="margin-right: 15px;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"> Select All
                </label>
                <button onclick="deleteSelectedStudents()" class="delete-btn">Delete Selected</button>
            </div>
            <div style="overflow-x: auto;">
                <div id="submittedList"></div>
            </div>
        </div>
        <div class="action-buttons">
            <button onclick="downloadStudentCOData()">Download All CO Data (CSV)</button>
            <button onclick="homePage()" style="background-color: green; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
                Go Back
            </button>
            <button onclick="resetPage()">Reset Page</button>
        </div>
    </div>
    <div id="learnerModal" class="modal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 900px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <span class="close" onclick="closeLearnerModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">×</span>
            <h2 id="learnerModalTitle" style="color: #c01520; margin-bottom: 15px;"></h2>
            <div id="learnerModalContent" style="max-height: 500px; overflow-y: auto;">
                <div id="learnerSummary" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
                <div id="learnerDetailsTable" style="overflow-x: auto;"></div>
            </div>
            <button onclick="downloadLearnerResults()" style="margin-top: 15px; background-color: #2196F3; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; float: right;">
                <i class="fas fa-download"></i> Download List
            </button>
            <div style="clear: both;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let pageId = "";
        let questionMarks = {};
        let selectedCOs = {};
        let coWeights = {};
        let studentData = [];
        let studentList = [];
        let currentStudent = null;
        let totalQMarks = 0;
        let activeCOs = new Set();
        let editMode = false;
        let currentEditIndex = -1;
        let selectedStudents = new Set();
        let currentStatus = "P";
        let currentFileData = null;
        let currentFileType = null;
        let currentLearnerResults = [];
        let currentLearnerType = '';

        // Get pageId from URL
        function getPageIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('pageId') || 'default';
        }

        // Load data from Page 1
        function loadPage1Data() {
            try {
                const pageData = JSON.parse(localStorage.getItem(pageId)) || {};
                selectedCOs = pageData.selectedCOs || {};
                questionMarks = pageData.questionMarks || {};
                coWeights = pageData.coWeights || { CO1: 0, CO2: 0, CO3: 0, CO4: 0, CO5: 0 };

                // Populate activeCOs based on selectedCOs
                Object.values(selectedCOs).forEach(co => {
                    if (co && co !== "Not Assigned") {
                        activeCOs.add(co);
                    }
                });

                // Calculate total question marks
                totalQMarks = Object.values(questionMarks).reduce((sum, marks) => sum + Number(marks), 0);
            } catch (e) {
                console.error("Error loading Page 1 data:", e);
                alert("Failed to load data from Page 1. Initializing with defaults.");
                initializeDefaultQuestions();
            }
        }

        // Initialize default questions if no data
        function initializeDefaultQuestions() {
            questionMarks = {
                "Q1": 0, "Q2": 0, "Q3": 0, "Q4": 0, "Q5": 0, "Q6": 0, "Q7": 0
            };
            selectedCOs = {};
            coWeights = { CO1: 0, CO2: 0, CO3: 0, CO4: 0, CO5: 0 };
            activeCOs.clear();
            totalQMarks = 0;
        }

        // Initialize the page
        window.onload = function() {
            // Get pageId
            pageId = getPageIdFromUrl();

            // Load data from Page 1
            loadPage1Data();

            // Load persisted student data
            loadPersistedData();

            // Initialize UI
            populateTable();
            populateStudentDropdown();
            updateSubmittedList();
            updateProgressSummary();

            // Show student list if available
            if (studentList.length > 0) {
                showStudentList();
            }

            document.getElementById("questionsTable").style.display = "table";
            updateCODisplay();
            updateTotalMarksDisplay();
            updateCOCards();
        };

        // Load persisted student data
        function loadPersistedData() {
            try {
                const storedStudentData = localStorage.getItem(`studentData_${pageId}`);
                if (storedStudentData) {
                    studentData = JSON.parse(storedStudentData);
                    if (!Array.isArray(studentData)) {
                        studentData = [];
                    }
                }

                const storedStudents = localStorage.getItem(`studentList_${pageId}`);
                if (storedStudents) {
                    studentList = JSON.parse(storedStudents);
                    if (!Array.isArray(studentList)) {
                        studentList = [];
                    }
                }
            } catch (e) {
                console.error("Error loading persisted data:", e);
                studentData = [];
                studentList = [];
            }
        }

        // Save student data
        function saveStudentData() {
            try {
                localStorage.setItem(`studentData_${pageId}`, JSON.stringify(studentData));
                localStorage.setItem(`studentList_${pageId}`, JSON.stringify(studentList));
            } catch (e) {
                console.error("Error saving student data:", e);
            }
        }

        // Analyze learners
        function analyzeLearners(type) {
            if (studentData.length === 0) {
                alert("No student data available for analysis!");
                return;
            }
            currentLearnerType = type;
            currentLearnerResults = [];
            const totalMarks = totalQMarks;
            studentData.forEach(student => {
                if (student.Status === "A" || student.Status === "I") {
                    return;
                }
                const studentMarks = Number(student["Total Marks"]) || 0;
                const percentage = (studentMarks / totalQMarks) * 100;
                if (type === 'slow' && percentage <= 40) {
                    currentLearnerResults.push({
                        uid: student.UID,
                        name: student.Name,
                        marks: studentMarks,
                        percentage: percentage.toFixed(2),
                        totalMarks: totalMarks,
                        coMarks: getCOMarkDetails(student)
                    });
                } else if (type === 'fast' && percentage >= 85) {
                    currentLearnerResults.push({
                        uid: student.UID,
                        name: student.Name,
                        marks: studentMarks,
                        percentage: percentage.toFixed(2),
                        totalMarks: totalMarks,
                        coMarks: getCOMarkDetails(student)
                    });
                }
            });
            displayLearnerResults();
        }

        // Get CO mark details for a student
        function getCOMarkDetails(student) {
            let coDetails = [];
            activeCOs.forEach(co => {
                if (student[co] !== undefined) {
                    coDetails.push({
                        co: co,
                        marks: student[co]
                    });
                }
            });
            return coDetails;
        }

        // Display learner results
        function displayLearnerResults() {
            const modalTitle = document.getElementById("learnerModalTitle");
            const summaryDiv = document.getElementById("learnerSummary");
            const tableDiv = document.getElementById("learnerDetailsTable");
            if (currentLearnerResults.length === 0) {
                modalTitle.textContent = `No ${currentLearnerType} learners found`;
                summaryDiv.innerHTML = `<p>No students meet the criteria for ${currentLearnerType} learners.</p>`;
                tableDiv.innerHTML = '';
                document.getElementById("learnerModal").style.display = "block";
                return;
            }
            const typeName = currentLearnerType === 'slow' ? 'Slow' : 'Fast';
            const criteria = currentLearnerType === 'slow' ? '≤40%' : '≥85%';
            const totalMarks = totalQMarks;
            modalTitle.textContent = `${typeName} Learners Analysis`;
            summaryDiv.innerHTML = `
                <p><strong>Total ${typeName} Learners:</strong> ${currentLearnerResults.length}</p>
                <p><strong>Criteria:</strong> ${criteria} of total marks (${totalMarks})</p>
                <p><strong>Average Percentage:</strong> ${calculateAveragePercentage()}%</p>
            `;
            let html = `<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background-color: #c01520; color: white;">
                        <th style="padding: 10px; text-align: left;">No.</th>
                        <th style="padding: 10px; text-align: left;">UID</th>
                        <th style="padding: 10px; text-align: left;">Name</th>
                        <th style="padding: 10px; text-align: center;">Marks Obtained</th>
                        <th style="padding: 10px; text-align: center;">Total Marks</th>
                        <th style="padding: 10px; text-align: center;">Percentage</th>
                    </tr>
                </thead>
                <tbody>`;
            currentLearnerResults.forEach((student, index) => {
                html += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; color: black;">${index + 1}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; color: black;">${student.uid}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; color: black;">${student.name}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; color: black;">${student.marks}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; color: black;">${totalQMarks}</td>
                        <td style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${currentLearnerType === 'slow' ? '#ff9800' : '#4caf50'};">
                            ${student.percentage}%
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            tableDiv.innerHTML = html;
            document.getElementById("learnerModal").style.display = "block";
        }

        // Calculate average percentage
        function calculateAveragePercentage() {
            if (currentLearnerResults.length === 0) return 0;
            const total = currentLearnerResults.reduce((sum, student) => sum + parseFloat(student.percentage), 0);
            return (total / currentLearnerResults.length).toFixed(2);
        }

        // Close learner modal
        function closeLearnerModal() {
            document.getElementById("learnerModal").style.display = "none";
        }

        // Download learner results
        function downloadLearnerResults() {
            if (currentLearnerResults.length === 0) {
                alert("No learner results to download!");
                return;
            }
            const type = currentLearnerType === 'slow' ? 'Slow' : 'Fast';
            const filename = `${type}_Learners_List.csv`;
            let csvContent = "No,UID,Name,Marks,Total Marks,Percentage";
            activeCOs.forEach(co => {
                csvContent += `,${co}`;
            });
            csvContent += "\n";
            currentLearnerResults.forEach((student, index) => {
                csvContent += `${index + 1},${student.uid},"${student.name}",${student.marks},${student.totalMarks},${student.percentage}%`;
                activeCOs.forEach(co => {
                    const coMark = student.coMarks.find(item => item.co === co);
                    csvContent += `,${coMark ? coMark.marks : '-'}`;
                });
                csvContent += "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Handle status change
        function handleStatusChange() {
            currentStatus = document.getElementById("studentStatus").value;
            updateInputFields();
            updateCOMarks();
            updateCOCards();
        }

        // Sort student list
        function sortStudentList() {
            if (studentList.length === 0) {
                alert("No students to sort!");
                return;
            }
            studentList.sort((a, b) => {
                return a.UID.toString().localeCompare(b.UID.toString());
            });
            saveStudentData();
            showStudentList();
            populateStudentDropdown();
            alert("Student list sorted by UID!");
        }

        // Update input fields based on status
        function updateInputFields() {
            Object.keys(questionMarks).forEach(q => {
                let input = document.getElementById(`${q}_marks`);
                if (currentStatus === "A") {
                    input.type = "text";
                    input.value = "A";
                    input.readOnly = true;
                } else if (currentStatus === "I") {
                    input.type = "text";
                    input.value = "I";
                    input.readOnly = true;
                } else {
                    input.type = "number";
                    input.readOnly = false;
                    input.min = "0";
                    input.max = questionMarks[q];
                    input.value = "";
                }
            });
        }

        // Process Excel file
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Process CSV file
        function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        const csvData = lines.map(line => line.split(','));
                        resolve(csvData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Upload marks from file
        async function uploadMarksFromFile() {
            let fileInput = document.getElementById("marksFile");
            let file = fileInput.files[0];
            if (!file) {
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: red;">Please select a file!</span>`;
                return;
            }
            const fileType = document.querySelector('input[name="marksFileType"]:checked').value;
            try {
                let data;
                if (fileType === 'excel') {
                    data = await processExcelFile(file);
                } else {
                    data = await processCSVFile(file);
                }
                currentFileData = data;
                currentFileType = fileType;
                document.getElementById("removeMarksBtn").style.display = "inline-block";
                document.getElementById("downloadUpdatedFile").style.display = "block";
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: green;">File "${file.name}" uploaded successfully!</span>`;
            } catch (error) {
                console.error("Error processing file:", error);
                document.getElementById("marksUploadStatus").innerHTML = 
                    `<span style="color: red;">Error processing file: ${error.message}</span>`;
            }
        }

        // Remove uploaded marks file
        function removeMarksFile() {
            document.getElementById("marksFile").value = "";
            document.getElementById("removeMarksBtn").style.display = "none";
            document.getElementById("downloadUpdatedFile").style.display = "none";
            document.getElementById("marksUploadStatus").innerHTML = "";
            currentFileData = null;
            currentFileType = null;
        }

        function removeMarksFile1() {
            document.getElementById("studentFile").value = "";
            document.getElementById("removeMarksBtn1").style.display = "none";
        }

        // Download updated file
        function downloadUpdatedFile() {
            if (!currentFileData) {
                alert("No file data available to process!");
                return;
            }
            const fileType = document.querySelector('input[name="downloadFileType"]:checked').value;
            let updatedData = processFileData(currentFileData);
            if (updatedData.length === 0) return;
            if (fileType === 'excel') {
                try {
                    let ws = Array.isArray(updatedData[0]) ? XLSX.utils.aoa_to_sheet(updatedData) : XLSX.utils.json_to_sheet(updatedData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "MarksData");
                    XLSX.writeFile(wb, "updated_marks.xlsx");
                } catch (error) {
                    console.error("Error generating Excel file:", error);
                    alert("Error generating Excel file: " + error.message);
                }
            } else {
                let csvContent;
                if (Array.isArray(updatedData[0])) {
                    csvContent = updatedData.map(row => row.join(',')).join('\n');
                } else {
                    const headers = Object.keys(updatedData[0]);
                    csvContent = [
                        headers.join(','),
                        ...updatedData.map(row => headers.map(h => row[h]).join(','))
                    ].join('\n');
                }
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "updated_marks.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Process file data
        function processFileData(data) {
            let updatedData = [];
            const isArrayOfArrays = Array.isArray(data[0]);
            let headers = isArrayOfArrays ? data[0] : Object.keys(data[0]);
            const uidCol = headers.findIndex(h => h.includes("UID"));
            const coCol = headers.findIndex(h => h.includes("CourseOu"));
            const marksCol = headers.findIndex(h => h.includes("MarkObtd"));
            if (uidCol === -1 || coCol === -1 || marksCol === -1) {
                alert("Required columns (UID, CourseOu, MarkObtd) not found in file!");
                return [];
            }
            for (let i = isArrayOfArrays ? 1 : 0; i < data.length; i++) {
                let row = data[i];
                if (!Array.isArray(row)) {
                    row = headers.map(h => row[h]);
                }
                let uid = row[uidCol] ? row[uidCol].toString().trim() : '';
                let co = row[coCol] ? row[coCol].toString().trim() : '';
                if (uid && co) {
                    let matchingStudent = studentData.find(s => s.UID === uid);
                    if (matchingStudent) {
                        row[marksCol] = matchingStudent[co] || 0;
                    }
                }
                updatedData.push(row);
            }
            return isArrayOfArrays ? [headers, ...updatedData] : updatedData.map(row => {
                let obj = {};
                headers.forEach((h, idx) => {
                    obj[h] = row[idx];
                });
                return obj;
            });
        }

        // Upload student list
        async function uploadStudentList() {
            let fileInput = document.getElementById("studentFile");
            let file = fileInput.files[0];
            if (!file) {
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Please select a file!</span>`;
                return;
            }
            const fileType = document.querySelector('input[name="studentFileType"]:checked').value;
            try {
                let data;
                if (fileType === 'excel') {
                    data = await processExcelFile(file);
                } else {
                    data = await processCSVFile(file);
                }
                if (!data || data.length === 0) {
                    throw new Error("File is empty or couldn't be processed");
                }
                let tempStudentList = [];
                let duplicateCount = 0;
                let seenCombinations = new Set();
                for (let i = 1; i < data.length; i++) {
                    try {
                        let row = data[i];
                        if (!row) continue;
                        let name, uid;
                        if (Array.isArray(row)) {
                            name = row[0] ? row[0].toString().trim() : '';
                            uid = row[2] ? row[2].toString().trim() : '';
                        } else {
                            name = row.Name ? row.Name.toString().trim() : '';
                            uid = row.UID ? row.UID.toString().trim() : '';
                        }
                        if (!uid) continue;
                        let combinationKey = `${uid}_${name}`;
                        if (seenCombinations.has(combinationKey)) {
                            duplicateCount++;
                            continue;
                        }
                        seenCombinations.add(combinationKey);
                        tempStudentList.push({ UID: uid, name: name });
                    } catch (e) {
                        console.error(`Error processing row ${i}:`, e);
                    }
                }
                if (tempStudentList.length === 0) {
                    throw new Error("No valid student records found in file");
                }
                studentList = tempStudentList;
                saveStudentData();
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: green;">Successfully uploaded ${studentList.length} students!</span>`;
                document.getElementById("removeMarksBtn1").style.display = "inline-block";
                if (duplicateCount > 0) {
                    document.getElementById("duplicateWarning").style.display = "block";
                    document.getElementById("duplicateWarning").textContent = 
                        `Note: ${duplicateCount} duplicate entries were removed.`;
                } else {
                    document.getElementById("duplicateWarning").style.display = "none";
                }
                showStudentList();
                populateStudentDropdown();
                updateProgressSummary();
            } catch (error) {
                console.error("Error processing student list:", error);
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Error: ${error.message || "Failed to process file"}</span>`;
            }
        }

        // Delete student list
        function deleteStudentList() {
            if (confirm("Are you sure you want to delete the uploaded student list?")) {
                studentList = [];
                saveStudentData();
                document.getElementById("studentList").innerHTML = "";
                document.getElementById("studentSelect").innerHTML = '<option value="">-- Select Student --</option>';
                document.getElementById("studentListContainer").style.display = "none";
                document.getElementById("uploadStatus").innerHTML = 
                    `<span style="color: red;">Student list deleted!</span>`;
                document.getElementById("duplicateWarning").style.display = "none";
                updateProgressSummary();
            }
        }

        // Show student list
        function showStudentList() {
            let container = document.getElementById("studentList");
            container.innerHTML = "";
            if (studentList.length === 0) {
                container.innerHTML = "<p>No students uploaded</p>";
                document.getElementById("studentListContainer").style.display = "none";
                return;
            }
            studentList.forEach(student => {
                let div = document.createElement("div");
                div.className = "student-item";
                div.innerHTML = `
                    <span>${student.name} (${student.UID})</span>
                `;
                div.onclick = function() {
                    document.getElementById("studentSelect").value = student.UID;
                    document.querySelectorAll(".student-item").forEach(item => {
                        item.classList.remove("selected");
                    });
                    div.classList.add("selected");
                };
                container.appendChild(div);
            });
            document.getElementById("studentListContainer").style.display = "block";
        }

        // Populate student dropdown
        function populateStudentDropdown() {
            let select = document.getElementById("studentSelect");
            select.innerHTML = '<option value="">-- Select Student --</option>';
            studentList.forEach(student => {
                let option = document.createElement("option");
                option.value = student.UID;
                option.textContent = `${student.name} (${student.UID})`;
                select.appendChild(option);
            });
        }

        // Populate questions table
        function populateTable() {
            let tableBody = document.getElementById("coTableBody");
            tableBody.innerHTML = "";
            totalQMarks = 0;
            if (Object.keys(questionMarks).length === 0) {
                initializeDefaultQuestions();
            }
            Object.keys(questionMarks).sort().forEach(q => {
                let maxMarks = Number(questionMarks[q]) || 0;
                totalQMarks += maxMarks;
                let co = selectedCOs[q] || "Not Assigned";
                let row = document.createElement("tr");
                let input = document.createElement("input");
                input.id = `${q}_marks`;
                input.oninput = function() { 
                    updateCOMarks(); 
                    updateCOCards();
                };
                if (currentStatus === "A") {
                    input.type = "text";
                    input.value = "A";
                    input.readOnly = true;
                } else if (currentStatus === "I") {
                    input.type = "text";
                    input.value = "I";
                    input.readOnly = true;
                } else {
                    input.type = "number";
                    input.min = "0";
                    input.max = maxMarks;
                }
                row.innerHTML = `
                    <td>${q}</td>
                    <td>${maxMarks}</td>
                    <td>${co}</td>
                    <td></td>
                `;
                row.cells[3].appendChild(input);
                tableBody.appendChild(row);
            });
            document.getElementById("questionsTable").style.display = "table";
            updateCODisplay();
            updateTotalMarksDisplay();
            updateCOCards();
        }

        // Toggle select all
        function toggleSelectAll(selectAllCheckbox) {
            let checkboxes = document.querySelectorAll('#submittedList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                let index = Array.from(checkboxes).indexOf(checkbox);
                if (selectAllCheckbox.checked) {
                    selectedStudents.add(index);
                } else {
                    selectedStudents.delete(index);
                }
            });
            updateSelectAllCheckbox();
        }

        // Update select all checkbox
        function updateSelectAllCheckbox() {
            let checkboxes = document.querySelectorAll('#submittedList input[type="checkbox"]');
            let selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.disabled = true;
                return;
            }
            selectAllCheckbox.disabled = false;
            let allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            selectAllCheckbox.checked = allChecked;
        }

        // Update CO display
        function updateCODisplay() {
            let coMarksContainer = document.getElementById("coMarksContainer");
            coMarksContainer.innerHTML = "";
            let sortedCOs = Array.from(activeCOs).sort();
            sortedCOs.forEach(co => {
                let p = document.createElement("p");
                p.innerHTML = `<b>${co}:</b> <span id="${co.toLowerCase()}Marks" class="red-bold">0</span>`;
                coMarksContainer.appendChild(p);
            });
        }

        // Update CO cards
        function updateCOCards() {
            let coCardsContainer = document.getElementById("coCardsContainer");
            coCardsContainer.innerHTML = "";
            let coMarks = {};
            let coMaxMarks = {};

            // Initialize marks and max marks for each CO
            activeCOs.forEach(co => {
                coMarks[co] = 0;
                coMaxMarks[co] = 0;
            });

            // Calculate total marks and max marks per CO
            Object.keys(questionMarks).forEach(q => {
                let assignedCO = selectedCOs[q];
                if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                    let maxMarks = Number(questionMarks[q]) || 0;
                    coMaxMarks[assignedCO] += maxMarks;
                    if (currentStatus !== "A" && currentStatus !== "I") {
                        let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                        if (marks > maxMarks) {
                            marks = maxMarks;
                            document.getElementById(`${q}_marks`).value = maxMarks;
                        }
                        coMarks[assignedCO] += marks;
                    }
                }
            });

            // Create cards for each CO
            let sortedCOs = Array.from(activeCOs).sort();
            sortedCOs.forEach(co => {
                let obtained = currentStatus === "A" ? "A" : (currentStatus === "I" ? "I" : coMarks[co]);
                let max = coMaxMarks[co];
                let percentage = (obtained !== "A" && obtained !== "I" && max > 0) ? (obtained / max * 100).toFixed(0) : 0;
                let card = document.createElement("div");
                card.className = "co-card";
                card.innerHTML = `
                    <h4>${co}</h4>
                    <p>Marks: <span class="red-bold">${obtained}/${max}</span></p>
                    <p>Progress: ${percentage}%</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${percentage}%"></div>
                    </div>
                `;
                coCardsContainer.appendChild(card);
            });
        }

        // Update CO marks
        function updateCOMarks() {
            let totalObtainedMarks = 0;
            let coMarks = {};
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });
            if (currentStatus === "A") {
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "A";
                    }
                });
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = "A";
                });
                // document.getElementById("totalCOMarks").innerText = "A";
                document.getElementById("totalMarksDisplay").innerText = `A/${totalQMarks}`;
            } else if (currentStatus === "I") {
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "I";
                    }
                });
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = "I";
                });
                // document.getElementById("totalCOMarks").innerText = "I";
                document.getElementById("totalMarksDisplay").innerText = `I/${totalQMarks}`;
            } else {
                Object.keys(questionMarks).forEach(q => {
                    let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                    let maxMarks = questionMarks[q];
                    if (marks > maxMarks) {
                        alert(`Marks for ${q} cannot exceed ${maxMarks}`);
                        document.getElementById(`${q}_marks`).value = maxMarks;
                        marks = maxMarks;
                    }
                    totalObtainedMarks += marks;
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] += marks;
                    }
                });
                activeCOs.forEach(co => {
                    document.getElementById(`${co.toLowerCase()}Marks`).innerText = coMarks[co];
                });
                // document.getElementById("totalCOMarks").innerText = Object.values(coMarks).reduce((a, b) => a + b, 0);
                document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
            }
            updateCOCards();
        }

        // Update total marks display
        function updateTotalMarksDisplay() {
            let totalObtainedMarks = 0;
            Object.keys(questionMarks).forEach(q => {
                let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                totalObtainedMarks += marks;
            });
            document.getElementById("totalMarksDisplay").innerText = `${totalObtainedMarks}/${totalQMarks}`;
        }

        // Submit student data
        function submitStudentData() {
            let selectedUID = document.getElementById("studentSelect").value;
            if (!selectedUID) {
                alert("Please select a student!");
                return false;
            }
            let student = studentList.find(s => s.UID === selectedUID);
            if (!student) {
                alert("Student not found in list!");
                return false;
            }
            let duplicateIndices = [];
            studentData.forEach((s, index) => {
                if (s.UID === selectedUID && (!editMode || index !== currentEditIndex)) {
                    duplicateIndices.push(index);
                }
            });
            if (duplicateIndices.length > 0) {
                let duplicateMessage = `Found ${duplicateIndices.length} existing record(s) for ${student.name} (${selectedUID}):\n`;
                duplicateIndices.forEach(index => {
                    let dup = studentData[index];
                    duplicateMessage += `- Record ${index + 1}: Status ${dup.Status}, Marks: ${dup["Total Marks"]}\n`;
                });
                duplicateMessage += "\nDo you want to overwrite these existing records?";
                if (!confirm(duplicateMessage)) {
                    return false;
                }
                duplicateIndices.sort((a, b) => b - a).forEach(index => {
                    studentData.splice(index, 1);
                });
                if (editMode) {
                    duplicateIndices.forEach(index => {
                        if (index < currentEditIndex) {
                            currentEditIndex--;
                        }
                    });
                }
            }
            let status = document.getElementById("studentStatus").value;
            let questionMarksData = {};
            Object.keys(questionMarks).forEach(q => {
                questionMarksData[q] = document.getElementById(`${q}_marks`).value || 0;
            });
            let totalObtainedMarks = 0;
            let coMarks = {};
            activeCOs.forEach(co => {
                coMarks[co] = 0;
            });
            if (status === "A") {
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "A";
                    }
                });
            } else if (status === "I") {
                Object.keys(questionMarks).forEach(q => {
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] = "I";
                    }
                });
            } else {
                Object.keys(questionMarks).forEach(q => {
                    let marks = Number(document.getElementById(`${q}_marks`).value) || 0;
                    totalObtainedMarks += marks;
                    let assignedCO = selectedCOs[q];
                    if (assignedCO && assignedCO !== "Not Assigned" && activeCOs.has(assignedCO)) {
                        coMarks[assignedCO] += marks;
                    }
                });
            }
            let studentRecord = {
                UID: selectedUID,
                Name: student.name,
                Status: status,
                ...coMarks,
                "Total Marks": status === "A" ? "A" : (status === "I" ? "I" : totalObtainedMarks),
                "QuestionMarks": questionMarksData,
                Timestamp: new Date().toLocaleString()
            };
            try {
                if (editMode && currentEditIndex !== -1) {
                    studentData[currentEditIndex] = studentRecord;
                } else {
                    studentData.push(studentRecord);
                }
                saveStudentData();
                document.getElementById("currentStudent").innerHTML = 
                    `<span style="color: green;">Current: ${student.name} (${student.UID}) - Status: ${status}</span>`;
                updateSubmittedList();
                updateProgressSummary();
                clearMarks();
                if (editMode) {
                    editMode = false;
                    currentEditIndex = -1;
                    document.getElementById("studentSelect").disabled = false;
                    document.getElementById("studentStatus").disabled = false;
                }
                alert(`Marks ${editMode ? 'updated' : 'submitted'} for ${student.name} (${student.UID})`);
                return true;
            } catch (e) {
                console.error("Error saving student data:", e);
                alert("Failed to save student data. Please try again.");
                return false;
            }
        }

        // Edit student data
        function editStudentData(index) {
            let student = studentData[index];
            document.getElementById("studentSelect").value = student.UID;
            document.getElementById("studentSelect").disabled = true;
            document.getElementById("studentStatus").value = student.Status || "P";
            currentStatus = student.Status || "P";
            clearMarks();
            if (student.QuestionMarks) {
                Object.keys(student.QuestionMarks).forEach(q => {
                    let input = document.getElementById(`${q}_marks`);
                    if (input) {
                        if (student.Status === "A") {
                            input.value = "A";
                            input.readOnly = true;
                        } else if (student.Status === "I") {
                            input.value = "I";
                            input.readOnly = true;
                        } else {
                            input.value = student.QuestionMarks[q];
                        }
                    }
                });
            }
            editMode = true;
            currentEditIndex = index;
            updateCOMarks();
            updateCOCards();
            document.getElementById("currentStudent").innerHTML = 
                `<span style="color: blue;">Editing: ${student.Name} (${student.UID}) - Status: ${student.Status || "P"}</span>`;
        }

        // Delete student data
        function deleteStudentData(index) {
            if (confirm("Are you sure you want to delete this student's data?")) {
                studentData.splice(index, 1);
                saveStudentData();
                updateSubmittedList();
                updateProgressSummary();
                alert("Student data deleted successfully!");
            }
        }

        // Delete selected students
        function deleteSelectedStudents() {
            if (selectedStudents.size === 0) {
                alert("Please select at least one student to delete!");
                return;
            }
            if (confirm(`Are you sure you want to delete ${selectedStudents.size} selected student(s)?`)) {
                let indices = Array.from(selectedStudents).sort((a, b) => b - a);
                indices.forEach(index => {
                    studentData.splice(index, 1);
                });
                saveStudentData();
                selectedStudents.clear();
                updateSubmittedList();
                updateProgressSummary();
                alert(`${indices.length} student(s) deleted successfully!`);
            }
        }

        // Toggle student selection
        function toggleStudentSelection(index, checkbox) {
            if (checkbox.checked) {
                selectedStudents.add(index);
            } else {
                selectedStudents.delete(index);
            }
            updateSelectAllCheckbox();
        }

        // Clear marks
        function clearMarks() {
            document.querySelectorAll("input[type='number'], input[type='text']").forEach(input => {
                input.type = "number";
                input.readOnly = false;
                input.min = "0";
                input.max = questionMarks[input.id.replace('_marks', '')] || 0;
                input.value = "";
            });
            document.getElementById("studentStatus").value = "P";
            currentStatus = "P";
            updateCOMarks();
            updateCOCards();
        }

        // Reset page
        function resetPage() {
            if (confirm("Are you sure you want to reset ALL data? This will clear:\n- All entered marks\n- Uploaded student list\n- All submitted student data\nNote: Page 1 data will not be affected.")) {
                try {
                    clearMarks();
                    document.getElementById("studentSelect").value = "";
                    document.getElementById("studentSelect").disabled = false;
                    document.getElementById("studentStatus").disabled = false;
                    editMode = false;
                    currentEditIndex = -1;
                    document.getElementById("currentStudent").innerHTML = "";
                    selectedStudents.clear();
                    studentList = [];
                    studentData = [];
                    localStorage.removeItem(`studentList_${pageId}`);
                    localStorage.removeItem(`studentData_${pageId}`);
                    document.getElementById("studentList").innerHTML = "";
                    document.getElementById("studentListContainer").style.display = "none";
                    document.getElementById("studentSelect").innerHTML = '<option value="">-- Select Student --</option>';
                    document.getElementById("uploadStatus").innerHTML = "";
                    document.getElementById("duplicateWarning").style.display = "none";
                    updateSubmittedList();
                    updateProgressSummary();
                    updateCOCards();
                    alert("Page has been completely reset. All student-related data has been cleared.");
                } catch (e) {
                    console.error("Error resetting page:", e);
                    alert("Error resetting page. Please refresh manually.");
                }
            }
        }

        // Update submitted students list
        function updateSubmittedList() {
            let container = document.getElementById("submittedList");
            container.innerHTML = "";
            if (studentData.length === 0) {
                container.innerHTML = "<p>No students submitted yet</p>";
                return;
            }
            let table = document.createElement("table");
            table.style.width = "100%";
            table.style.marginTop = "10px";
            let header = table.createTHead();
            let headerRow = header.insertRow();
            ["Select", "No", "Name", "UID", ...Array.from(activeCOs).sort(), "Total Marks", "Actions"].forEach(text => {
                let th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
            });
            let tbody = table.createTBody();
            studentData.forEach((student, index) => {
                let row = tbody.insertRow();
                let selectCell = row.insertCell();
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.onclick = (e) => toggleStudentSelection(index, e.target);
                selectCell.appendChild(checkbox);
                [index + 1, student.Name, student.UID].forEach(value => {
                    let cell = row.insertCell();
                    cell.textContent = value;
                });
                Array.from(activeCOs).sort().forEach(co => {
                    let cell = row.insertCell();
                    if (student.Status === "A") {
                        cell.innerHTML = '<span class="status-A">A</span>';
                    } else if (student.Status === "I") {
                        cell.innerHTML = '<span class="status-I">I</span>';
                    } else {
                        cell.textContent = student[co] || 0;
                    }
                });
                let totalCell = row.insertCell();
                if (student.Status === "A") {
                    totalCell.innerHTML = '<span class="status-A">A</span>';
                } else if (student.Status === "I") {
                    totalCell.innerHTML = '<span class="status-I">I</span>';
                } else {
                    totalCell.textContent = student["Total Marks"] || 0;
                }
                let actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn" onclick="editStudentData(${index})">Edit</button>
                    <button class="delete-btn" onclick="deleteStudentData(${index})">Delete</button>
                `;
            });
            container.appendChild(table);
            updateSelectAllCheckbox();
        }

        // Update progress summary
        function updateProgressSummary() {
            const progressSummary = document.getElementById("progressSummary");
            const totalStudentsCount = document.getElementById("totalStudentsCount");
            const submittedStudentsCount = document.getElementById("submittedStudentsCount");
            const pendingStudentsCount = document.getElementById("pendingStudentsCount");
            const pendingStudentsList = document.getElementById("pendingStudentsList");
            if (studentList.length === 0) {
                progressSummary.style.display = "none";
                return;
            }
            progressSummary.style.display = "block";
            const totalStudents = studentList.length;
            const submittedStudents = studentData.length;
            const pendingStudents = totalStudents - submittedStudents;
            totalStudentsCount.textContent = totalStudents;
            submittedStudentsCount.textContent = submittedStudents;
            pendingStudentsCount.textContent = pendingStudents;
            const submittedUIDs = new Set(studentData.map(s => s.UID));
            const pendingStudentsData = studentList.filter(s => !submittedUIDs.has(s.UID));
            if (pendingStudentsData.length === 0) {
                pendingStudentsList.innerHTML = "<div class='pending-student'>All students have marks submitted!</div>";
            } else {
                pendingStudentsList.innerHTML = "";
                pendingStudentsData.forEach(student => {
                    const div = document.createElement("div");
                    div.className = "pending-student";
                    div.textContent = `${student.UID} - ${student.name}`;
                    pendingStudentsList.appendChild(div);
                });
            }
        }

        // Download student CO data
        function downloadStudentCOData() {
            if (studentData.length === 0) {
                alert("No student data available to download!");
                return;
            }
            let headers = ["Serial No", "Name", "UID", "Status", "CO", "Marks", "Total Marks"];
            let csvContent = headers.join(",") + "\n";
            let serialNo = 1;
            studentData.forEach((student) => {
                let sortedCOs = Array.from(activeCOs).sort();
                sortedCOs.forEach(co => {
                    let row = [
                        serialNo++,
                        `"${student.Name || student.UID}"`,
                        student.UID,
                        student.Status || "P",
                        co,
                        student.Status === "A" ? "A" : (student.Status === "I" ? "I" : (student[co] || 0)),
                        student.Status === "A" ? "A" : (student.Status === "I" ? "I" : (student["Total Marks"] || 0))
                    ];
                    csvContent += row.join(",") + "\n";
                });
            });
            let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            let url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "Student_CO_Data_Detailed.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Go back to Page 1
        function homePage() {
            window.location.href = `MST_CO_Calc_WL.html?pageId=${pageId}`;
        }
    </script>
</body>
</html>